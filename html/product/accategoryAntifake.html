<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
	<link rel="styleSheet" href="../../css/framework/table.css?v=1.0.1">
	<link rel="styleSheet" href="../../css/framework/module.css?v=1.0.1">
    <base href="./">
	<title>防伪内容</title>
	<style>
		ul {
			list-style: none;
		}
		li {
			margin: 10px 0 0 10px;
		}
		.centerline,.section {
			position: relative;
			overflow: hidden;
			height: 25px;
		}
		.centerline:after {
			content: "";
		    display: block;
		    height: 1px;
		    top: 50%;
		    position: relative;
		    background: #000;
		}
		.centerBtn {
			position: absolute;
    		right: 0;
    		z-index: 4;
		}
		label {
			display: inline-block;
			width: 60px;
			text-align: right;
		}
		textarea {
			width: 300px;
    		height: 100px;
			vertical-align: text-top;
		}
		.warn {
			color: red;
			padding-left: 60px;
		}
		.imgOut {
			padding-left: 60px;
			overflow: hidden;
		}
		.upload {
			margin-left: 50px;
		}
	</style>
</head>
<body>
	<form action="" method="POST">
		<div class="module" style="width: 100%;">
			<div class="title">
	    		<div class="item selected" v-cloak>防伪内容</div>	
	    	</div>
	    	<div class="content">
	    		<div class="item selected" style="padding:10px;">
	    			<div class="section">
	    			</div>
	    			<div class="main">
	    				
	    			</div>
	    		</div>
	    		<div class="submit" v-if="PAGETYPE != 'detail'">
	    		    <center>
	    		    	<input type="button" class="saveBtn" value="保存">
	    		    </center>
	    		</div>
	    	</div>
		</div>
	</form>

	<script src="../../js/jquery/jquery-1.8.3.min.js?v=1.0.1"></script>
	<script src="../../plugins/AjaxUploader-0.0.1.js?v=1.0.1"></script>
	<script src="../../js/default.js?v=1.0.1"></script>
	<script>
		//获取防伪内容
		/*junAjax({
			url: "",
			success: function(result){*/
				result = {
					code: "200", 
					data: [
						{
							img: "MDlhYWUxYWEtM2FlYi00OWZhLWIwMmEtZDY2YWRjMjY0MDdhLnBuZw==",
							info: "sdfdf"
						},
						{
							img: "MGE4ZjQyZTEtNzE4ZC00MmY1LWFlODItNmNmNjZiNGU3MGQzLnBuZw==",
							info: "32534243"
						},
						{
							img: "MDlhYWUxYWEtM2FlYi00OWZhLWIwMmEtZDY2YWRjMjY0MDdhLnBuZw==",
							info: "xxxxx"
						}
					]
				};
				if(result.code != "200"){
					alert(result.data);
				}else{
					init(result.data);
				}
			/*},
			error: function(){
				alert("网络错误 ！");
			}
		});*/
		function init(data){
			if(data.length){
				$(".section").html('<input type="button" class="centerBtn" value="删除一组" onclick="delGroup()">');
				$(".main").html('<ul><li><label>操作：</label><input type="button" class="addPart" value="增加一栏" onclick="addPart()"></li></ul>');
				var docfrag = document.createDocumentFragment();
				for(var i=0; i<data.length; i++){
					setPart(data[i], i+1, docfrag);
				}
				$(".main").append(docfrag);
			}else{
				$(".section").html('<input type="button" class="centerBtn" value="增加一组" onclick="addGroup">');
			}
		}
		function setPart(param, index, docfrag){
			var $part = $(
				'<ul>\
					<li class="centerline"><input type="button" class="delPart centerBtn" value="删除一栏" onclick="delpart(this)"></li>\
					<li><label>步骤：</label><span>步骤'+index+'</span></li>\
					<li>\
						<label>图片：</label>\
						<div class="imgOut">\
							<div></div>\
	  						<button class="upload" onclick="upload(this)">上传图片</button>\
						</div>\
						<span class="warn">请注意：上传的图片大小不能超过500K</span>\
					</li>\
					<li><label>说明：</label><textarea>'+param.info+'</textarea></li>\
		  		</ul>'
		  	);
		  	if(param.img != null){ 		
			  	var $file = fileStyle.createFilePicture({
					src: "http://127.0.0.1:8080/file.center/rest/o/download/temp/"+param.img+"/"+document.body.clientWidth,
					width: 120,
					height: 120,
					deleteFun: function(obj){
						$(obj).html("<div class='jun-attachment' style='width:120px;height:120px;border:1px solid #ccc'></div>");
					}
				});
				$part.find(".imgOut div").html($file);
		  	}else{
		  		$part.find(".imgOut div").html("<div class='jun-attachment' style='width:120px;height:120px;border:1px solid #ccc'></div>");
		  	}
			docfrag.appendChild($part[0]);
		}
		function delpart(obj){
			$(obj).parents("ul").fadeOut(1000, function(){
				$(this).remove();
				reSort();
			});
		}
		function addPart(){
			var index = $(".main > ul").size();
			setPart({img:null,info:""},index,$(".main")[0]);
		}
		function upload(obj){
			new AjaxUploader({
				url: "http://127.0.0.1:8080/file.center/rest/o/uploads/temp",
				name: "files",
				before: function(file){
					//验证
					if(!file||file[0].type.indexOf("image")<0){
						alert("请选择一张图片");
						return false;
					}
					if(file[0].size>500*1024){
						alert("请你选择一张小于500K的图片");
						return false;
					}
					return true;
				},
				callBack:function(result){
					//处理结果，显示预览
					if(result && result.data){
						for(var i=0;i<result.data.length;i++){
							var $file = fileStyle.createFilePicture({
								src: "http://127.0.0.1:8080/file.center/rest/o/download/temp/"+result.data[i]+"/"+document.body.clientWidth,
								width: 120,
								height: 120
							});
							$(obj).prev().html($file);
						}
					}
				}
			});
		}
		function delGroup(){
			$(".section").html('<input type="button" class="centerBtn" value="增加一组" onclick="addGroup()">');
			$(".main").empty();
		}
		function addGroup(){
			var data = [{
				info: "",
				img: null
			},{
				info: "",
				img: null
			}];
			init(data);
		}
		function reSort(){
			var part = $(".main ul:not(:first-child)");
			for(var i=0; i<part.length; i++){
				part.eq(i).find("li:nth-child(2) span").text("步骤"+(i+1));
			}
		}
	</script>
</body>
</html>
